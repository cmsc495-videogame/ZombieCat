<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Zombie Cat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.5.1/pixi.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.0.5/howler.js"></script>
    <script type="text/javascript" src="DeadCat/Utils.js"></script>
    <script type="text/javascript" src="DeadCat/Object.js"></script>
    <script type="text/javascript" src="DeadCat/GraphicsManager.js"></script>
    <script type="text/javascript" src="DeadCat/KeyboardManager.js"></script>
    <script type="text/javascript" src="DeadCat/LogicManager.js"></script>
    <script type="text/javascript" src="DeadCat/AudioManager.js"></script>
    <script type="text/javascript" src="DeadCat/deadcat.js"></script>

</head>
<body>
<!--<p>CMSC495 Project</p>-->
<div id="display"></div>
<style type="text/css">
    html, body {
        height: 100%;
        margin: 0;
        overflow: hidden;
        background-color: black;
    }

    #display {
        display: flex;
        justify-content: center;
    }
</style>
<script type="text/javascript">
    /*This script is demo code that shows the game engine off*/
    /*This script has somehow became the game*/

    var game;
    Levels = ["mainmenu.json", "shipLevel.json"];
    game = new DeadCat("maps/" + Levels[0], mainMenuSetup, MainMenuLoop);

    //main menu


    function mainMenuSetup() {
        mainMenuLayer = game.LogicManager.getLayerByName("MainMenu");
        game.LogicManager.positionAbsolute(mainMenuLayer, "center");

        //var introMusic = game.LogicManager.getObjectByNameInLayer(mainMenuLayer, "intromusic");
        game.AudioManager.playSound("intromusic");
    }

    function MainMenuLoop() {
        if (game.KeyboardManager.keysPressed[13]) {
            // introMusic.DestroySound(); //stop and tear down intro audio
            LoadLevel(1);
        }
    }

    function LoadLevel(level) {
        game.destroy();
        if (level == 0)
            game = new DeadCat("maps/" + Levels[0], mainMenuSetup, MainMenuLoop);
        else
            game = new DeadCat("maps/" + Levels[level], setup, menuloop);
        currentLevel = level;
    }

    //playable level
    var currentLevel = 1;
    var player = null;
    var animationDelta = 0;
    var Animations = {};
    var collisionLayer = null;

    var cats = null;
    var catGid = 0;

    var healthBar = null;

    var objectLayer = null;
    var mainMenuLayer = null;
    var hudLayer = null;

    function setup() {
        //get the main menu
        mainMenuLayer = game.LogicManager.getLayerByName("MainMenu");
        game.LogicManager.positionAbsolute(mainMenuLayer, "center");

        //Create Health Bar-----------------------------------
        //health bar layer
        hudLayer = game.LogicManager.getLayerByName("HUD");
        game.LogicManager.positionAbsolute(hudLayer, "top-left");
        hudLayer.x += 20;
        hudLayer.y += 20;
        //create heath bar
        healthBar = hudLayer.addGraphics()

        //Create the black background rectangle
        var innerBar = hudLayer.addGraphics();
        innerBar.beginFill(0x000000);
        innerBar.alpha = 0.5;
        innerBar.drawRect(0, 0, 200, 24);
        innerBar.endFill();
        healthBar.innerBar = innerBar;

        //Create the front red rectangle
        var outerBar = hudLayer.addGraphics()
        outerBar.beginFill(0xFFFFFF);
        outerBar.drawRect(0, 0, 200, 24);
        outerBar.endFill();
        outerBar.tint = 0x00FF00;
        healthBar.outer = outerBar;
        //----------------------------------------------------

        //get map layer
        collisionLayer = game.LogicManager.getLayerByName("Collision");
        //get objects layer (holds player and animations)
        objectLayer = game.LogicManager.getLayerByName("Objects");

        //setup the player-----------------------------------
        //
        //get the player sprite
        player = game.LogicManager.getObjectByNameInLayer(objectLayer, "PlayerSprite");
        //center the whole map, by the player position
        game.LogicManager.centerObject(player);
        //since we change the player gid to the animation gids, we need to save the original player gid
        player.oldPlayerGid = player.gid;
        player.facing = "down";
        player.direction = 270;  //Track direction of movement for attacks

        //copies the animations from the player layer to a list
        for (ani in objectLayer.children) {
            Animations[objectLayer.children[ani].name] = objectLayer.children[ani].gid;
        }

        //setup the cats--------------------------------------
        //
        //get the cat sprite
        cats = game.LogicManager.getObjectsByNameInLayer(objectLayer, "Zombie");
        catGid = cats[0].gid;
        //set some random speeds for the cats
        for (var cat in cats) {
            cats[cat].properties.speed = Math.random() * ((cats[cat].properties.speed + .4) - (cats[cat].properties.speed - 0.4)) + (cats[cat].properties.speed - 0.4);
        }

        //Set up sounds---------------------------------------
        game.AudioManager.playSound("music_background");

    }


    function menuloop(game, delta) {
        if (game.KeyboardManager.keysPressed[13] && player.properties.health > 0) {
            mainMenuLayer.visible = false;
            game.setLoop(gameloop);
            return;
        }

        //Restart current level by pressing 'r'
        if (game.KeyboardManager.keysPressed[82]) {
            LoadLevel(currentLevel);
            return;
        }

        //Load Main Menu by pressing 'm'
        if (game.KeyboardManager.keysPressed[77]) {
            LoadLevel(0)
            return;
        }

        //Toggle Background music
        if (game.KeyboardManager.keysPressed[81]) {
            game.AudioManager.toggleSound("music_background");
        }
    }


    var catOldX = 0.0;
    var catOldY = 0.0;

    function gameloop(game, delta) {

        //escape to show main menu
        if (game.KeyboardManager.keysPressed[27] == true) {
            mainMenuLayer.visible = true;
            game.setLoop(menuloop);
        }


        var mvDelta = delta * 5;
        var moveX = 0;
        var moveY = 0;
        player.gid = player.oldPlayerGid;

        var oldx = player.x;
        var oldy = player.y


        //--Player Health----------------------------------------------
        //

        //Game Over action...
        if (player.properties.health <= 0) {
            //Game Over
            game.AudioManager.playSound(player.properties.sound_die);
            //Pop up menu for now
            mainMenuLayer.visible = true;
            game.setLoop(menuloop);
        }

        //Update healthbar
        updateHealthBar();


        //--Attacking----------------------------------------------
        //

        //Reduce Attack Cooldown
        if (player.properties.attack_rechargeState > 0) {
            player.properties.attack_rechargeState--;
        }

        //Attack button (Spacebar)
        if (game.KeyboardManager.keysPressed[32] == true) {
            if (player.facing == "down")
                player.gid = Animations.player_attack_stick_down;
            if (player.facing == "up")
                player.gid = Animations.player_attack_stick_up;
            if (player.facing == "left")
                player.gid = Animations.player_attack_stick_left;
            if (player.facing == "right")
                player.gid = Animations.player_attack_stick_right;

            //Attack cats nearby when attack is recharged
            var closestCat = null;
            var closestCatDistance = null;
            if (player.properties.attack_rechargeState == 0) {

                //Player Attack sound
                game.AudioManager.playSound(player.properties.sound_attack);
                //------------------

                console.log('attack');
                for (var cat in cats) {
                    if (cats[cat].properties.state_dead != 1) {
                        var currentCatDistance = game.LogicManager.distance(player, cats[cat]);
                        if (currentCatDistance <= player.properties.attack_range) {
                            if (Math.abs(game.LogicManager.angle(player, cats[cat]) - player.direction) <= player.properties.attack_angle) {
                                if (closestCat) {
                                    if (currentCatDistance < closestCatDistance) {
                                        closestCat = cat;
                                        closestCatDistance = currentCatDistance;
                                    }
                                } else {
                                    closestCat = cat;
                                    closestCatDistance = currentCatDistance;
                                }
                            }
                        }
                    }
                }
                if (closestCat) {
                    cats[closestCat].properties.health -= player.properties.attack_damage;

                    //Sound - Cat_Hurt
                    game.AudioManager.playSound(cats[cat].properties.sound_hurt);
                    //------------------

                    //Debug: console.log('attack cat: ' + closestCat + '  to health: ' + cats[closestCat].properties.health);
                }
                player.properties.attack_rechargeState = player.properties.attack_rechargeTime;
            }
        }


        //--Movement----------------------------------------------
        //
        if (game.KeyboardManager.keysPressed[87] == true) {
            moveY += mvDelta;
            player.gid = Animations.player_move_forward;
            player.facing = "up";
        }
        if (game.KeyboardManager.keysPressed[83] == true) {
            moveY -= mvDelta;
            player.gid = Animations.player_move_back;
            player.facing = "down";
        }
        if (game.KeyboardManager.keysPressed[65] == true) {
            moveX += mvDelta;
            player.gid = Animations.player_move_left;
            player.facing = "left";
        }
        if (game.KeyboardManager.keysPressed[68] == true) {
            moveX -= mvDelta;
            player.gid = Animations.player_move_right;
            player.facing = "right";
        }
        if (moveX != 0 && moveY != 0) {
            moveX = moveX / 1.3;
            moveY = moveY / 1.3;
        }
        if (moveX != 0 || moveY != 0) {
            var mapx = game.LogicManager.getMapX();
            var mapy = game.LogicManager.getMapY();
            game.LogicManager.setMapX(mapx + moveX);
            game.LogicManager.setMapY(mapy + moveY);
            //everything on the map moved, so lets move the player back
            player.x -= moveX;
            player.y -= moveY;

            //Update player direction for attacks
            player.direction = Math.atan2(0 - moveX, moveY) * 180 / Math.PI;

            //Play or continue playing movement sound.
            game.AudioManager.resumeSound(player.properties.sound_move);

            //update the player because we may have changed to an animation
            //game.updateObject(player); //we will do this later
            //since the collision of the player just got updated on the gui change
            //you can do a collision test after
            if (game.LogicManager.hitTestLayer(player, collisionLayer)) {
                player.x = oldx;
                player.y = oldy;
                game.LogicManager.setMapX(mapx);
                game.LogicManager.setMapY(mapy);
            }
        }else{
            game.AudioManager.stopSound(player.properties.sound_move);
        }

        //--Cat Logic----------------------------------------------
        //

        for (var cat in cats) {
            //if the player is near, chase the player
            if (cats[cat].properties.state_dead == 0) {
                if (cats[cat].properties.health <= 0) {
                    cats[cat].properties.state_dead = 1;
                    cats[cat].gid = Animations.cat_explode;
                    game.AudioManager.playSound(cats[cat].properties.sound_die);
                    continue;
                }

                //if (game.LogicManager.distance(player, cats[cat]) <= cats[cat].properties.sight)
                  //  cats[cat].properties.chase = true;
                if(cats[cat].properties.chase == false){
                    if(game.LogicManager.lineOfSight(player, cats[cat], collisionLayer)) {
                        cats[cat].properties.chase = true;
                        console.log("Cat: " + cat + " can see you");
                        game.AudioManager.playSound(cats[cat].properties.sound_move);
                    }
                }else if(game.LogicManager.distance(player, cats[cat]) > cats[cat].properties.sight*1.2){
                    game.AudioManager.stopSound(cats[cat].properties.sound_move);
                    console.log("You gave cat: " + cat + " the slip");
                    cats[cat].properties.chase = false;
                }


                //--Cat Attack----------------------------------------------
                //
                //Cat Attacks when near and recharged
                if (cats[cat].properties.attack_rechargeState <= 0 && game.LogicManager.lineOfSight(player, cats[cat], collisionLayer)) {
                    if (game.LogicManager.distance(player, cats[cat]) <= cats[cat].properties.attack_range) {
                        if(game.LogicManager.lineOfSight(player, cats[cat], collisionLayer)) {
                            player.properties.health -= cats[cat].properties.attack_damage;
                            cats[cat].properties.attack_rechargeState = cats[cat].properties.attack_rechargeTime;

                            //Cat attack sound
                            game.AudioManager.playSound(cats[cat].properties.sound_attack);
                            game.AudioManager.playSound(player.properties.sound_hurt);
                            //Update healthbar
                            updateHealthBar();
                        }
                    }
                } else cats[cat].properties.attack_rechargeState--;


                //--Cat Movement----------------------------------------------
                //
                if (cats[cat].properties.chase && game.LogicManager.distance(player, cats[cat]) > 48) {

                    catOldX = cats[cat].x;
                    catOldY = cats[cat].y;


                    game.LogicManager.moveToObjectX(cats[cat], player, delta * 2 * cats[cat].properties.speed);
                    if (game.LogicManager.hitTestLayer(cats[cat], collisionLayer)) {
                        cats[cat].x = catOldX;
                    }
                    game.LogicManager.moveToObjectY(cats[cat], player, delta * 2 * cats[cat].properties.speed);
                    if (game.LogicManager.hitTestLayer(cats[cat], collisionLayer)) {
                        cats[cat].y = catOldY;
                    }

                    cats[cat].dx = cats[cat].x - catOldX;
                    cats[cat].dy = cats[cat].y - catOldY;

                    cats[cat].gid = catGid;

                    if (Math.abs(cats[cat].dy) > Math.abs(cats[cat].dx)) {
                        if (cats[cat].dy >= 0)
                            cats[cat].gid = Animations.cat_move_forward;
                        else
                            cats[cat].gid = Animations.cat_move_back;
                    } else {
                        if (cats[cat].dx >= 0)
                            cats[cat].gid = Animations.cat_move_right;
                        else
                            cats[cat].gid = Animations.cat_move_left;
                    }
                    game.AudioManager.resumeSound(cats[cat].properties.sound_move);
                }
            }
        }


        //update animated tiles
        for (var tile in objectLayer.children) {
            game.updateObject(objectLayer.children[tile]);
        }

        //update the zOrder of all objects
        game.LogicManager.yZOrder(objectLayer);



    }


    //--Update Size of HealthBar----------------------------------------------
    //

    function updateHealthBar() {
        healthBar.outer.width = player.properties.health * 2;

        //Health Bar to Green
        if (player.properties.health >= 70) {
            healthBar.outer.tint = 0x00FF00;
        } else if (player.properties.health >= 30) { //Health Bar to Yellow
            healthBar.outer.tint = 0xFFFF00;
        } else //Health Bar to Red
            healthBar.outer.tint = 0xFF3300;

        //Does not display health below 0
        if (healthBar.outer.width < 0)
            healthBar.outer.width = 0;
    }

</script>
</body>
</html>