<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Zombie Cat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.5.1/pixi.min.js"></script>
    <script type="text/javascript" src="DeadCat/Utils.js"></script>
    <script type="text/javascript" src="DeadCat/Object.js"></script>
    <script type="text/javascript" src="DeadCat/GraphicsManager.js"></script>
    <script type="text/javascript" src="DeadCat/KeyboardManager.js"></script>
    <script type="text/javascript" src="DeadCat/LogicManager.js"></script>
    <script type="text/javascript" src="DeadCat/deadcat.js"></script>

</head>
<body>
<p>CMSC495 Project</p>
<div id="display"></div>
<script type="text/javascript">
/*This script is demo code that shows the game engine off*/

    var game = new DeadCat("maps/sandbox.json", setup, gameloop);

    var player = null;
    var oldPlayerGid = 0;
    var animationDelta = 0;
    var Animations = {};
    var mapLayer = null;

    var cats = null;
    var catGid = 0;

    var objectLayer = null;

    function setup() {
        //get map layer
        mapLayer = game.LogicManager.getLayerByName("Main");
        //get player layer (holds player and animations)
        objectLayer = game.LogicManager.getLayerByName("Objects");
        //get the player sprite
        player = game.LogicManager.getObjectByNameInLayer(objectLayer, "PlayerSprite");
        //center the whole map, by the player position
        game.LogicManager.centerObject(player);
        //since we change the player gid to the animation gids, we need to save the original player gid
        oldPlayerGid = player.gid;
        //copies the animations from the player layer to a list
        for (ani in objectLayer.children) {
            Animations[objectLayer.children[ani].name] = objectLayer.children[ani].gid;
        }

        //get the cat layer
        var catLayer = game.LogicManager.getLayerByName("Cat1");
        //get the cat sprite
        cats = game.LogicManager.getObjectsByNameInLayer(objectLayer, "Zombie");
        catGid = cats[0].gid;

        //get animated objects
        player.zOrder = -110;

    }

    var catOldX = 0.0;
    var catOldY = 0.0;

    function gameloop(game, delta) {
        var mvDelta = delta * 5;
        var moveX = 0;
        var moveY = 0;
        player.gid = oldPlayerGid;

        var oldx = player.x;
        var oldy = player.y;

        if (game.KeyboardManager.keysPressed[87] == true) {
            moveY += mvDelta;
            player.gid = Animations.player_move_forward;
        }
        if (game.KeyboardManager.keysPressed[83] == true) {
            moveY -= mvDelta;
            player.gid = Animations.player_move_back;
        }
        if (game.KeyboardManager.keysPressed[65] == true) {
            moveX += mvDelta;
            player.gid = Animations.player_move_left;
        }
        if (game.KeyboardManager.keysPressed[68] == true) {
            moveX -= mvDelta;
            player.gid = Animations.player_move_right;
        }
        if (moveX != 0 && moveY != 0) {
            moveX = moveX / 1.3;
            moveY = moveY / 1.3;
        }
        if (moveX != 0 || moveY != 0) {
            var mapx = game.LogicManager.getMapX();
            var mapy = game.LogicManager.getMapY();
            game.LogicManager.setMapX(mapx + moveX);
            game.LogicManager.setMapY(mapy + moveY);
            //everything on the map moved, so lets move the player back
            player.x -= moveX;
            player.y -= moveY;

            //update the player because we may have changed to an animation
            game.updateObject(player);
            //since the collision of the player just got updated on the gui change
            //you can do a collision test after
            if (game.LogicManager.hitTestLayer(player, mapLayer)) {
                player.x = oldx;
                player.y = oldy;
                game.LogicManager.setMapX(mapx);
                game.LogicManager.setMapY(mapy);
            }
        }


        for (var cat of cats) {
            //if the player is near, chase the player
            if (game.LogicManager.distance(player, cat) <= cat.properties.sight )
                cat.properties.chase = true;


                if(cat.properties.chase && game.LogicManager.distance(player, cat)> 48)
                {
                catOldX = cat.x;
                catOldY = cat.y;
                game.LogicManager.moveToObjectX(cat, player, delta * 2 * cat.properties.speed);
                if (game.LogicManager.hitTestLayer(cat, mapLayer)) {
                    cat.x = catOldX;
                }
                game.LogicManager.moveToObjectY(cat, player, delta * 2 * cat.properties.speed);
                if (game.LogicManager.hitTestLayer(cat, mapLayer)) {
                    cat.y = catOldY;
                }

                cat.dx=cat.x-catOldX;
                cat.dy=cat.y-catOldY;

                cat.gid = catGid;
                if(Math.abs(cat.dy)>Math.abs(cat.dx)){
                    if(cat.dy >= 0)
                        cat.gid = Animations.cat_move_up;
                    else
                        cat.gid = Animations.cat_move_down;
                }else{
                    if(cat.dx >= 0)
                        cat.gid = Animations.cat_move_right;
                    else
                        cat.gid = Animations.cat_move_left;
                }


                game.updateObject(cat);
            }
        }


        //update animated tiles
        for(var tile of objectLayer.children)
        {
            game.updateObject(tile);
        }
        game.LogicManager.yZOrder(objectLayer);

    }

</script>
</body>
</html>